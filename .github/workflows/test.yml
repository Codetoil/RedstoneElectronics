name: test
on: [pull_request, push]

jobs:
  test:
    strategy:
      matrix:
        dist: [
          temurin
        ]
        # Use these Java versions
        java: [
          17,    # Current LTS version of Java & minimum supported by Minecraft
        ]
        # and run on both Linux and Windows
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1
      - name: Setup JDK ${{ matrix.dist }}-${{ matrix.java }}
        uses: actions/setup-java@v2
        with:
          distribution: ${{ matrix.dist }}
          java-version: ${{ matrix.java }}
      - name: Make Gradle Wrapper Executable
        if: ${{ runner.os != 'Windows' }}
        run: chmod +x ./gradlew
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Setup Yarn CI
        run: yarn install --frozen-lockfile
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: Gradle Caches
      - name: Run Data Generator Preperation
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 1000
          max_attempts: 10
          retry_on: error
          command: ./gradlew prepareRunData
      - name: Run Data Generation
        continue-on-error: true
        run: ./gradlew runData
      - name: Run Testing Script
        run: yarn test
      - name: Run Minecraft Test Server
        run: ./gradlew runGameTestServer
      - name: Capture Reports
        if: ${{ runner.os == 'Linux' && matrix.java == '17' && matrix.dist == 'temurin' }} # Only upload artifacts built from LTS java on one OS
        uses: actions/upload-artifact@v3
        with:
          name: Reports
          path: |
            src/generated/resources
            gametest
